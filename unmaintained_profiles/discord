# AppArmor profile for discord proprietary chat program
# Version of discord profiled: March 22, 2020
# Homepage: https://gitlab.com/krathalan/apparmor-profiles
# Copyright 2019 (C) krathalan; Licensed under GPLv3

# This profile assumes you only want to upload files from `~/{D,d}ownloads`. 
# If you do not, add local changes. Discord does not need access to your whole 
# home directory.

# This profile intentionally does not enable hardware acceleration due to the 
# deeper level of system access hardware acceleration requires, the [insecurity 
# of modern graphics drivers, and the reluctance to give proprietary software 
# deeper system access than it truly needs.

# Streamer mode and showing any currently playing games/music/etc. will not work 
# as `ptrace` is completely disabled in this profile, as Discord tries to run 
# `ptrace` on every program running on your machine. `ptrace` is an extremely 
# dangerous capability.

#include <tunables/global>

profile discord /{usr,opt}/{bin,discord}/{D,d}iscord {
  #include <abstractions/audio>
  #include <abstractions/base>
  #include <abstractions/fonts>
  #include <abstractions/krathalans-common-gui>
  #include <abstractions/krathalans-hardening>
  #include <abstractions/krathalans-hwaccel>
  #include <abstractions/krathalans-hwaccel-nvidia>

  # Networking
  #include <abstractions/krathalans-networking>
  owner @{HOME}/.pki/nssdb/* rwk,

  # Subprocesses
  /usr/bin/dash mrix,
  /opt/discord/Discord mrix,
  /opt/discord/chrome-sandbox mrix,
  owner /dev/shm/.org.chromium.Chromium.* rw,

  # Discord will not work at all without this
  capability setgid,
  capability setuid,
  capability sys_chroot,
  capability sys_admin,
  @{PROC}/ r,
  owner @{PROC}/*/{gid_map,setgroups,uid_map} w,
  owner @{PROC}/*/fd/ r,
  owner /tmp/discord.sock w,
  /sys/bus/pci/devices/ r,
  /sys/bus/pci/devices/[0-9]*/{class,device,irq,resource,vendor} r,
  /sys/devices/pci[0-9]*/{class,device,irq,resource,vendor} r,
  /sys/devices/pci[0-9]*/[0-9]*/{class,device,irq,resource,vendor} r,
  /sys/devices/pci[0-9]*/[0-9]*/[0-9]*/{class,device,irq,resource,vendor} r,

  # Miscellaneous
  /opt/discord/** r,
  owner /run/user/*/discord* w,

  # Allow access to downloads folder for uploads ONLY (no downloads)
  owner @{HOME}/{D,d}ownloads/ r,
  owner @{HOME}/{D,d}ownloads/** r,

  # Config -- even tho mw permissions are somewhat unfortunate, discord needs
  # this to run as it downloads the actual application to this directory
  owner @{HOME}/.config/discord/ rw,
  owner @{HOME}/.config/discord/** mrwk,

  # Don't allow opening files with arbitrary programs
  deny /usr/bin/xdg-mime x,
  deny /usr/bin/xdg-open x,

  # File picker still works without these permissions
  deny /etc/{fstab,machine-id} r,
  deny /run/user/*/dconf/user rw,
  deny @{HOME}/.cache/thumbnails/** rw,
  deny @{HOME}/.config/dconf/user rw,

  # Discord does this supposedly to look for OBS/games you're playing
  deny capability sys_ptrace,
  deny ptrace,

  # Deny unnecessary permissions
  deny @{HOME}/.pki/ rw,
  deny /dev/pts/[0-9] rw,
  deny /dev/tty* rw,
  deny "/tmp/Discord Crashes/" w,
  deny /sys/devices/virtual/tty/tty0/active r,
  deny /proc/*/{cmdline,oom_score_adj,stat,statm,comm} rw,
  deny /proc/*/task/ r,
  deny /proc/sys/fs/inotify/max_user_watches r,
  deny /proc/sys/kernel/yama/ptrace_scope r,
}
