# AppArmor profile for gpg-agent
# Version of gpg-agent (gnupg) profiled: 2.2.20
# Homepage: https://git.sr.ht/~krathalan/apparmor-profiles/
# Copyright 2019 (C) krathalan; Licensed under GPLv3

#include <tunables/global>

profile gpg-agent /usr/bin/gpg-agent {
  #include <abstractions/base>
  #include <abstractions/krathalans-hardening>

  # Access user keys and config
  #include <abstractions/gnupg>
  owner @{HOME}/{.gnupg,.local/share/gnupg}/private-keys*/{,*} w,
  owner @{HOME}/{.gnupg,.local/share/gnupg}/private-keys*/* r,
  owner @{HOME}/{.gnupg,.local/share/gnupg}/sshcontrol rw,

  # Copy <abstractions/gnupg> with XDG_DATA_HOME
  owner @{HOME}/.local/share/gnupg/options     r,
  owner @{HOME}/.local/share/gnupg/pubring.gpg r,
  owner @{HOME}/.local/share/gnupg/pubring.kbx r,
  owner @{HOME}/.local/share/gnupg/random_seed rw,
  owner @{HOME}/.local/share/gnupg/secring.gpg r,
  owner @{HOME}/.local/share/gnupg/so/*.x86_64 mr,
  owner @{HOME}/.local/share/gnupg/trustdb.gpg rw,

  # Include user overrides for possible symlinked config files
  #include <local/gpg-agent>

  # Curses pinentry
  /usr/bin/pinentry-curses rix,
  /dev/pts/* rw,
  @{system_share_dirs}/terminfo/** r,

  # Socket
  owner /run/user/*/gnupg/{,**} rw,

  # Arch Linux keyring
  owner /etc/pacman.d/gnupg/{,**} rw,

  # fwupd
  capability dac_read_search,
  capability dac_override,
  owner /etc/nsswitch.conf r,
  owner /etc/passwd r,
  owner /var/lib/fwupd/gnupg/{,**} rw,

  # aurutils
  owner /var/lib/aurbuild/**/etc/pacman.d/gnupg/{,**} rw,

  # Miscellaneous
  /usr/bin/{bash,dash} rix,
  @{system_share_dirs}/gnupg/* r,

  # I don't have hardware to test this
  deny /usr/lib/gnupg/scdaemon rx,

  # Silence unnecessary permissions
  deny @{PROC}/@{pid}/** r,
  deny /var/cache/** w,
}
