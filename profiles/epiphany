# AppArmor profile for epiphany web browser
# Version of program profiled: 3.38.1
# Homepage: https://git.sr.ht/~krathalan/apparmor-profiles/
# Copyright 2020 (C) krathalan; Licensed under GPLv3

abi <abi/3.0>,
include <tunables/global>

profile epiphany /usr/bin/epiphany {
  include <abstractions/base>
  include <abstractions/enchant>
  include <abstractions/fonts>
  include <abstractions/krathalans-common-gui>
  include <abstractions/krathalans-hwaccel>
  include <abstractions/krathalans-nameservice>
  include <abstractions/krathalans-networking>

  network netlink raw,
  network unix stream,

  /usr/bin/epiphany r,

  # User data
  owner @{HOME}/.cache/epiphany/{,**} rw,
  owner @{HOME}/.cache/mesa_shader_cache/index rw,
  owner /run/user/*/dconf/user rw,
  owner @{HOME}/.config/dconf/user r,
  owner @{HOME}/.config/enchant/{,**} rw,
  owner @{HOME}/.config/fontconfig/conf.d/{,**} r,
  owner @{user_share_dirs}/epiphany/{,**,.*} rw,

  # Misc
  /etc/services r,
  @{system_share_dirs}/applications/{,mimeinfo.cache} r,
  @{system_share_dirs}/glvnd/egl_vendor.d/{,**} r,
  @{system_share_dirs}/glib-[0-9]*/schemas/gschemas.compiled r,
  @{sys}/devices/virtual/dmi/id/chassis_type r,
  @{sys}/firmware/acpi/pm_profile r,
  @{PROC}/zoneinfo r,
  owner /tmp/epiphany*/{,**} rw,

  # Include local overrides for conf files or Nvidia users
  include if exists <local/epiphany>

  /usr/lib/epiphany/ephy-profile-migrator rCx,
  profile ephy-profile-migrator /usr/lib/epiphany/ephy-profile-migrator {
    include <abstractions/base>
    /usr/lib/epiphany/ephy-profile-migrator r,
  }

  /usr/lib/WebKitNetworkProcess rCx,
  profile WebKitNetworkProcess /usr/lib/WebKitNetworkProcess {
    include <abstractions/base>
    include <abstractions/krathalans-networking>
    include <abstractions/openssl>
    include <abstractions/p11-kit>

    network netlink raw,
    network inet dgram,
    network inet6 dgram,
    network inet stream,

    /usr/lib/WebKitNetworkProcess mr,

    # User data
    owner @{HOME}/.cache/epiphany/{,**} rw,
    owner /run/user/*/dconf/user rw,
    owner @{HOME}/.config/dconf/user rw,
    owner @{user_share_dirs}/epiphany/{,**,.*} rw,

    # Misc
    /etc/services r,
    @{system_share_dirs}/glib-[0-9]*/schemas/gschemas.compiled r,

    deny /proc/*/statm r,
  }

  /usr/lib/WebKitWebProcess rCx,
  profile WebKitWebProcess /usr/lib/WebKitWebProcess {
    include <abstractions/base>
    include <abstractions/fonts>
    include <abstractions/krathalans-hwaccel>
    include <abstractions/krathalans-nameservice>
    include <abstractions/openssl>

    /usr/lib/WebKitWebProcess mr,

    # User data
    owner @{HOME}/.cache/epiphany/{,**} rw,
    owner @{HOME}/.cache/mesa_shader_cache/index rw,
    owner @{HOME}/.cache/gstreamer*/{,**} rw,
    owner @{HOME}/.config/fontconfig/conf.d/{,**} r,
    owner /run/user/*/dconf/user rw,
    owner @{HOME}/.config/dconf/user r,
    owner @{user_share_dirs}/epiphany/{,**,.*} rw,
    owner @{user_share_dirs}/mime/{,**} rw,

    # Misc
    @{system_share_dirs}/glib-[0-9]*/schemas/gschemas.compiled r,
    @{system_share_dirs}/glvnd/egl_vendor.d/{,**} r,
    @{system_share_dirs}/gtk-3.0/settings.ini r,
    @{system_share_dirs}/icons/{,**} r,
    @{system_share_dirs}/mime/{,**} rw,
    @{system_share_dirs}/themes/{,**} r,
    @{system_share_dirs}/X11/xkb/{,**} r,
    @{sys}/devices/virtual/dmi/id/chassis_type r,
    @{sys}/firmware/acpi/pm_profile r,
    /proc/zoneinfo r,
    owner /var/tmp/WebKit-Media* rw,

    # Include local overrides for conf files or Nvidia users
    include if exists <local/epiphany>

    # Deny unnecessary permissions
    deny @{HOME}/.cache/ r,
    deny /proc/*/fd/ r,
    deny /proc/*/cmdline r,
    deny /proc/*/statm r,
    deny /proc/*/smaps r,
  }

  # Deny unnecessary permissions
  deny /proc/sys/kernel/random/boot_id r,
  deny /proc/*/fd/ r,
  deny /proc/*/cgroup r,
  deny /proc/*/cmdline r,
  deny /proc/*/statm r,
}
