# AppArmor profile for epiphany web browser
# Version of program profiled: 3.38.1
# Homepage: https://git.sr.ht/~krathalan/apparmor-profiles/
# Copyright 2020 (C) krathalan; Licensed under GPLv3

abi <abi/3.0>,
include <tunables/global>

profile epiphany /usr/bin/epiphany {
  include <abstractions/base>
  include <abstractions/enchant>
  include <abstractions/fonts>
  include <abstractions/krathalans-common-gui>
  include <abstractions/krathalans-hwaccel>
  include <abstractions/krathalans-nameservice>
  include <abstractions/krathalans-networking>

  network netlink raw,
  network unix stream,

  /usr/bin/epiphany r,

  # Allow access for downloads and uploads
  #include <abstractions/krathalans-downloads>

  # Audio
  include <abstractions/audio>
  /usr/bin/pulseaudio rPx,

  # Xorg
  owner @{HOME}/.Xauthority r,

  # User data
  owner @{HOME}/.cache/epiphany/{,**} rwk,
  owner @{HOME}/.cache/mesa_shader_cache/index rw,
  owner @{HOME}/.config/dconf/user r,
  owner @{HOME}/.config/enchant/{,**} rw,
  owner @{HOME}/.config/epiphany/{,**} rw,
  owner @{HOME}/.config/fontconfig/conf.d/{,**} r,
  owner @{user_share_dirs}/epiphany/{,**,.*} rwk,
  owner @{user_share_dirs}/webkitgtk/{,**,.*} rwk,
  owner @{user_share_dirs}/recently-used.xbel* rw,

  # Runtime dir
  owner /run/user/*/dconf/user rw,
  owner /run/user/*/webkitgtk/{,**} w,

  # System access
  /etc/services r,
  @{system_share_dirs}/applications/{,mimeinfo.cache} r,
  @{system_share_dirs}/glvnd/egl_vendor.d/{,**} r,
  @{system_share_dirs}/glib-[0-9]*/schemas/gschemas.compiled r,
  @{sys}/devices/virtual/dmi/id/chassis_type r,
  @{sys}/firmware/acpi/pm_profile r,

  # Misc
  @{PROC}/zoneinfo r,

  # Tmp
  owner /tmp/epiphany*/{,**} rw,
  owner /tmp/ContentRuleList* rw,

  # Include local overrides for conf files or Nvidia users
  include if exists <local/epiphany>

  /usr/lib/epiphany/ephy-profile-migrator rCx,
  profile ephy-profile-migrator /usr/lib/epiphany/ephy-profile-migrator {
    include <abstractions/base>
    /usr/lib/epiphany/ephy-profile-migrator r,
  }

  /usr/lib/WebKitNetworkProcess rCx,
  profile WebKitNetworkProcess /usr/lib/WebKitNetworkProcess {
    include <abstractions/base>
    include <abstractions/krathalans-networking>
    include <abstractions/openssl>
    include <abstractions/p11-kit>

    network netlink raw,
    network inet dgram,
    network inet6 dgram,
    network inet stream,
    network inet6 stream,

    /usr/lib/WebKitNetworkProcess mr,

    # Allow access for downloads and uploads
    #include <abstractions/krathalans-downloads>

    # User data
    owner @{HOME}/.cache/epiphany/{,**} rw,
    owner /run/user/*/dconf/user rw,
    owner @{HOME}/.config/dconf/user rw,
    owner @{user_share_dirs}/epiphany/{,**,.*} rw,

    # System access
    /etc/services r,
    @{system_share_dirs}/glib-[0-9]*/schemas/gschemas.compiled r,

    # Deny unnecessary permissions
    deny @{PROC}/*/statm r,
  }

  /usr/lib/WebKitWebProcess rCx,
  profile WebKitWebProcess /usr/lib/WebKitWebProcess {
    include <abstractions/base>
    include <abstractions/fonts>
    include <abstractions/krathalans-hwaccel>
    include <abstractions/krathalans-nameservice>
    include <abstractions/openssl>

    /usr/lib/WebKitWebProcess mr,

    # Xorg
    owner @{HOME}/.Xauthority r,

    # User data
    owner @{HOME}/.cache/epiphany/{,**} rw,
    owner @{HOME}/.cache/mesa_shader_cache/index rw,
    owner @{HOME}/.cache/gstreamer*/{,**} rw,
    owner @{HOME}/.config/fontconfig/conf.d/{,**} r,
    owner @{HOME}/.config/dconf/user r,
    owner @{user_share_dirs}/epiphany/{,**,.*} rw,
    owner @{user_share_dirs}/mime/{,**} rw,

    # Runtime dir
    owner /run/user/*/dconf/user rw,

    # System access
    @{system_share_dirs}/glib-[0-9]*/schemas/gschemas.compiled r,
    @{system_share_dirs}/glvnd/egl_vendor.d/{,**} r,
    @{system_share_dirs}/gtk-3.0/settings.ini r,
    @{system_share_dirs}/icons/{,**} r,
    @{system_share_dirs}/mime/{,**} rw,
    @{system_share_dirs}/themes/{,**} r,
    @{system_share_dirs}/X11/xkb/{,**} r,
    @{sys}/devices/virtual/dmi/id/chassis_type r,
    @{sys}/firmware/acpi/pm_profile r,
    @{PROC}/zoneinfo r,

    # Tmp
    owner /var/tmp/WebKit-Media* rw,
    owner /tmp/ContentRuleList* rw,

    # Include local overrides for conf files or Nvidia users
    include if exists <local/epiphany>

    # Deny unnecessary permissions
    deny @{HOME}/.cache/ r,
    deny @{PROC}/*/{cmdline,statm,smaps} r,
    deny @{PROC}/*/fd/ r,
  }

  # Deny unnecessary permissions
  deny @{user_share_dirs}/applications/{,**} r,
  deny @{system_share_dirs}/applications/*.desktop r,
  deny @{PROC}/sys/kernel/random/boot_id r,
  deny @{PROC}/*/{cgroup,cmdline,mountinfo,mounts,statm} r,
  deny @{PROC}/*/fd/ r,
}
