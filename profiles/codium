# AppArmor profile for VSCodium editor
# Version of VSCodium profiled: 1.38.1
# Homepage: https://gitlab.com/krathalan/apparmor-profiles
# Copyright 2019 (C) krathalan; Licensed under GPLv3

#include <tunables/global>

profile codium /usr/{bin/codium,share/vscodium-bin/bin/codium,share/vscodium-bin/codium} {
  #include <abstractions/base>
  #include <abstractions/fonts>
  #include <abstractions/krathalans-common-gui>
  #include <abstractions/krathalans-hwaccel>

  # Helper programs
  #include <abstractions/bash>
  /usr/bin/{bash,dash,dirname,git,grep,id,readlink,which} rix,

  # Needed to browse and download extensions
  #include <abstractions/krathalans-networking>
  #include <abstractions/user-tmp>

  # Nvidia users
  #include <local/codium>

  # Needed to function at all
  /dev/shm/.org.chromium.Chromium.* rw,
  @{PROC}/ r,
  owner /run/user/*/vscode*.sock w,

  # Needed to render
  @{sys}/bus/pci/devices/ r,
  @{sys}/devices/pci[0-9]*/** r,

  # Chromium/Electron spawns and uses multiple processes
  @{system_share_dirs}/vscodium-bin/{,**} mr,
  /usr/{bin/codium,share/vscodium-bin/bin/codium,share/vscodium-bin/codium} rpx,

  # Needed to record open documents at shutdown and open them again at startup
  owner @{HOME}/.local/share/recently-used.xbel* rw,

  # Config
  owner @{HOME}/.config/VSCodium/{,**} k,
  owner @{HOME}/.vscode-oss/{,**} rw,

  # Needed to edit documents (including config files)
  owner @{HOME}/{,*} rw,
  owner @{HOME}/.config/{,**} rw,
  owner @{HOME}/{D,d}ocuments/{,**} rw,
  owner @{HOME}/{G,g}it/{,**} rw,

  # Protect sensitive file(s)
  deny @{HOME}/.bash_history rw,

  # File picker
  @{system_share_dirs}/glib-[0-9]*/schemas/gschemas.compiled r,

  # Needed to open links in Firefox
  /usr/bin/xdg-open rCx,

  profile xdg-open /usr/bin/xdg-open {
    #include <abstractions/base>

    # Helper programs
    /usr/bin/{cut,dash,dbus-send,egrep,grep,head,sed,which,xdg-mime} rix,
    /usr/bin/xdg-open r,

    # Browsers -- only allow Firefox
    /{opt/firefox-nightly,usr/bin,usr/lib/firefox*}/firefox* rPx,
    deny /usr/bin/lynx rx,

    # Config
    @{system_share_dirs}/applications/{,**} r,
    @{user_share_dirs}/applications/{,**} r,

    # Silence unnecessary permissions
    deny /usr/bin/{gawk,uname} rx,
  }

  # Needed for C/C++ Clang Command Adapter extension
  # https://marketplace.visualstudio.com/items?itemName=mitaki28.vscode-clang
  # Extension is MIT Licensed: https://github.com/mitaki28/vscode-clang
  signal send set=term peer=codium//clang,
  /usr/bin/clang-8 rCx,

  profile clang /usr/bin/clang-8 {
    #include <abstractions/base>
    #include <abstractions/fonts>

    signal receive set=term peer=codium,
    /usr/bin/clang-8 rix,

    # This is where all header files are
    /usr/include/{,**} r,

    # Clang needs access to the same directories as VSCodium to analyze and compile
    # But we probably don't need the base home dir and ~/.config directories :)
    @{system_share_dirs}/vscodium-bin/{,**} r,
    owner @{HOME}/{D,d}ocuments/{,**} rw,
    owner @{HOME}/{G,g}it/{,**} rw,
  }

  # Needed for shellcheck extension
  # https://marketplace.visualstudio.com/items?itemName=timonwong.shellcheck
  # Extension is MIT Licensed: https://github.com/timonwong/vscode-shellcheck
  /usr/bin/shellcheck rix,
  
  # Possibly needed for debugging?
  deny @{PROC}/sys/kernel/yama/ptrace_scope r,

  # An editor doesn't need audio
  deny /usr/bin/pulseaudio rx,
  deny /etc/pulse/client.conf r,
  deny /run/user/*/pulse/ rw,

  # GVFS isn't necessary
  deny /usr/share/gvfs/remote-volume-monitors/ r,

  # Dconf -- disabling this doesn't affect VSCodium
  deny owner /run/user/*/dconf/user rw,
  deny owner @{HOME}/.config/dconf/user r,

  # Use a separate terminal program
  deny /dev/ptmx rw,
  deny /dev/pts/[0-9] rw,
  deny /dev/tty rw,
  deny /dev/tty[0-9] rw,
  deny /sys/devices/virtual/tty/** r,

  # Silence unnecessary permissions
  deny signal send set=term peer=unconfined,
  deny /usr/bin/env rx,
  deny /dev/shm/ r,
  deny @{PROC}/version r,
  deny @{PROC}/vmstat r,
  deny @{PROC}/*/comm r,
  deny @{PROC}/*/fd/ r,
  deny @{PROC}/*/mountinfo r,
  deny @{PROC}/*/oom_score_adj w,
  deny @{PROC}/*/stat r,
  deny @{PROC}/*/statm r,
  deny @{PROC}/*/task/ r,
  deny @{sys}/devices/system/cpu/cpufreq/policy0/cpuinfo_max_freq r,
  deny @{HOME}/.pki/{,**} rw,
}
